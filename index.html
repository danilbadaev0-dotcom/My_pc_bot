<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>PC Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrap">
    <h2>PC Control</h2>

    <section class="row">
      <label>Текст → на ПК</label>
      <div class="inline">
        <input id="txt" placeholder="Напечатать на ПК…" autofocus>
        <button id="btnSend">Отправить</button>
      </div>
    </section>

    <section class="row">
      <label>Комбинация клавиш</label>
      <div class="inline">
        <label><input type="checkbox" id="mCtrl">CTRL</label>
        <label><input type="checkbox" id="mAlt">ALT</label>
        <label><input type="checkbox" id="mShift">SHIFT</label>
        <label><input type="checkbox" id="mWin">WIN</label>
        <input id="key" placeholder="Клавиша (например, R)">
        <button id="btnHotkey">Жмак</button>
      </div>
    </section>

    <section class="row">
      <label>Медиа</label>
      <div class="inline">
        <button data-act="mute">Mute</button>
        <button data-act="voldown">Vol−</button>
        <button data-act="volup">Vol+</button>
        <button data-act="prev">⏮</button>
        <button data-act="playpause">⏯</button>
        <button data-act="next">⏭</button>
      </div>
    </section>

    <section class="row">
      <label>Экран ПК (требуется HTTPS-доступ к агенту)</label>
      <img id="screen" alt="screenshot" style="width:100%;max-width:900px;border:1px solid #333;border-radius:8px">
      <div class="inline">
        <button id="btnRefresh">Обновить</button>
        <button id="btnApps">Список приложений</button>
      </div>
      <pre id="apps" class="pre"></pre>
    </section>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // Укажи публичный https хост агента (если есть). Иначе оставь пусто — картинка не будет подтягиваться.
    const PUBLIC_AGENT_BASE = ""; // например: "https://your-subdomain.trycloudflare.com"

    function toast(msg){ try{ tg.showPopup({message: msg}); }catch(e){ alert(msg);} }

    function sendToBot(payload){
      tg.sendData(JSON.stringify(payload));
      toast("Отправлено");
    }

    // текст
    document.getElementById('btnSend').onclick = () => {
      const txt = document.getElementById('txt').value || "";
      if (!txt.trim()) return toast("Пусто");
      sendToBot({type:'type_text', text: txt});
      document.getElementById('txt').value = "";
    };

    // хоткей
    document.getElementById('btnHotkey').onclick = () => {
      const mods = [];
      if (document.getElementById('mCtrl').checked) mods.push('ctrl');
      if (document.getElementById('mAlt').checked) mods.push('alt');
      if (document.getElementById('mShift').checked) mods.push('shift');
      if (document.getElementById('mWin').checked) mods.push('win');
      const key = (document.getElementById('key').value || "").trim();
      if (!key) return toast("Укажи клавишу");
      sendToBot({type:'hotkey', mods, key});
    };

    // медиа
    document.querySelectorAll('[data-act]').forEach(btn=>{
      btn.onclick = ()=> sendToBot({type:'media', action: btn.dataset.act});
    });

    // скрин
    function refreshScreen(){
      const img = document.getElementById('screen');
      if (!PUBLIC_AGENT_BASE){
        img.src = "";
        return;
      }
      img.src = PUBLIC_AGENT_BASE + "/screenshot.jpg?t=" + Date.now();
    }
    document.getElementById('btnRefresh').onclick = refreshScreen;
    refreshScreen(); setInterval(refreshScreen, 4000);

    // список приложений (2 режима)
    document.getElementById('btnApps').onclick = async ()=>{
      const pre = document.getElementById('apps');
      pre.textContent = "Загрузка...";
      if (PUBLIC_AGENT_BASE){
        // прямой запрос к агенту
        try{
          const r = await fetch(PUBLIC_AGENT_BASE + "/rpc", {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({secret:"FrogovWelder", cmd:"apps"})
          });
          const j = await r.json();
          if (!j.ok) throw new Error(j.error);
          const arr = j.result.slice(0, 200);
          pre.textContent = arr.map(x=>`• ${x.name}${x.version? " ("+x.version+")":""} [${x.source}]`).join("\n");
        }catch(e){
          pre.textContent = "Ошибка: " + e.message;
        }
      }else{
        // через бота (в чат уйдёт только краткая инфа), внутри WebApp список не покажем без публичного HTTPS
        sendToBot({type:'apps'});
        pre.textContent = "Запрошено через бота…";
      }
    };
  </script>
</body>
</html>
